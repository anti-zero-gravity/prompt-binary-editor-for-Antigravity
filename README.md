# Binary Prompt Editor

バイナリファイル（言語サーバーの実行ファイルなど）の中に埋め込まれたテキスト（システムプロンプト等）を検索・表示・編集するためのWebベースのHexエディタです。

![Python](https://img.shields.io/badge/Python-3.10+-blue) ![Flask](https://img.shields.io/badge/Flask-3.0+-green)

## 主な機能

- **Hexダンプビューア** — 仮想スクロールにより巨大なファイルも高速表示。
- **密度マップ** — 辞書単語の出現頻度を視覚化し、プロンプトの埋没箇所を特定。
- **スマート検索** — ASCII文字列の検索に加え、`%s` や `%d` などの**書式指定子（Verb）を含む文字列の曖昧マッチング**に対応。プロンプト内の変数部分を自動的に無視して位置を特定できます。
- **行マッピング** — 外部のプロンプトシート（Markdown等）の行テキストから、バイナリ内の対応するフラグメントを自動検出。
- **インライン編集** — 検索窓からの直接書き換え、Deleteキーによるスペース埋め。Undo/Redo完備。
- **セーフ保存** — 保存時に自動で `.bak` バックアップを作成。

## バイナリ書き換えの重要な手順

Antigravity 等の実行中のアプリケーションが使用しているファイルを直接編集する場合、以下のいずれかの手順を踏む必要があります。

### A. 直接編集する場合
1. Antigravity 等、対象のバイナリを使用しているアプリケーションを**完全に終了**させます。
2. 本ツールで `Save` を実行します。
3. 保存完了後、アプリケーションを再起動します。

### B. ワークスペースにコピーして編集する場合（推奨）
1. `Antigravity\resources\app\extensions\antigravity\bin\language_server_windows_x64.exe` を本ツールのワークスペース内にコピーします。
2. 本ツールでコピーしたファイルを読み込み、編集・保存します。
3. 編集済みのファイルを元のディレクトリへ上書きコピーして戻します。

## クイックスタート

### 1. 依存ライブラリのインストール
```bash
pip install -r requirements.txt
```

### 2. 起動
1. Windowsの場合、`start_editor.bat` をダブルクリックするだけでブラウザが起動します。
2. 初回起動はエクスプローラで編集対象バイナリのパスを求められます。
 Antigravity\resources\app\extensions\antigravity\bin\language_server_windows_x64.exe を直接開くか、選択画面内でバイナリを右ドラッグしてlanguage_server_windows_x64 - コピー.exeを作成してから、そのコピー.exeを開けばAntigravity起動中にsave可能になります。
 3. 選択パスはpath.iniに自動保存されます。

 ### 3. 編集作業
 1. **初期プロンプトを起動中のAntigravityのエージェント（ClaudeOpus)に出力させた、system_prompts_full.mdを同梱してます。**
 Antigravityのアップデート後は再出力させる方が良いと思いますが、前回（26年1月）のアップデートでは初期シスプロの変更はなかったので、プロンプトに変更があったと気付いたタイミングで更新しても良いと思います。
 2. **ユーザーの用途では不要と思われるプロンプトをエージェントと相談して洗い出し、システムロンプトを0x20で埋めて軽量化することが可能です。**
 - 例えば[https://hackmd.io/KHTN7kjrS6KrFyCbX1weZA](https://hackmd.io/KHTN7kjrS6KrFyCbX1weZA)を 開き、画面内文字を全選択してコピーします。
 - 次にツールの右下のclipボタンを押すと日時mdがワークススペースフォルダ内に作成され、下段に表示されます。プロンプト行を選択してからDELキーを押すと空白で埋めます。必要と思われる量・箇所をユーザー自身で判断して埋めます。
 - 正常にエージェントが機能するかテストします。以前と変わらない正常動作ならば、コンテキスト・トークンの節約ができます。
 - 同梱のプロンプトに戻したい場合は、日時.mdを削除するか、path.ini内のパスを書き換えて下さい
 3. **エージェントの振る舞いやツールの使い方を、プロンプトを書き換えることで改善可能です。**
 - エージェントに <MEMORY[user_global]>などの<user_rules>以外の、起動時にコンテキストに読み込まれるシステムプロンプトの内、どのプロンプトに従った結果の行動なのか？根拠となるプロンプトは？などと質問し、関連するシステムプロンプト文を吐き出させます。
 - そのプロンプトをツールの検索窓に入れて検索します。またはツールのブラウザの検索機能CTRL+Fでプロンプトを検索すると、system_prompts_full.md内のプロンプトの一文がヒットするので、その行をクリックしてバイナリを選択状態にします。
 - どのように改善すれば良いかエージェント自身に考えさせます。同じバイト長になるように考えろと指示します。
 - エージェントが考えた改善プロンプトを検索窓に入れると、バイト長が同じ場合に限り書き込みアイコンが有効になるので、exeを編集バイナリを直接指定の場合はAntigravityを終了してから書き込みます。または書き込み後にAntigravity\resources\app\extensions\antigravity\bin\language_server_windows_x64.exeとしてリネームし、元のパスへ書き戻します。
 4. **エージェントの動作を確認し、エージェントが期待した動作をしない。またはエージェントが起動しない場合はbakファイルから書き戻します。**
 - language_server_windows_x64.exe を削除します。
 - language_server_windows_x64.bak の拡張子をexeに変更します。　

## キーボードショートカット

| キー | 動作 |
|---|---|
| `Ctrl + Z` | Undo（元に戻す） |
| `Ctrl + Shift + Z` / `Ctrl + Y` | Redo（やり直し） |
| `Delete` | 選択範囲を `0x20` (スペース) で埋める |
| `Ctrl + Enter` | 検索実行 |

## 免責事項
このツールは自己責任で使用してください。バイナリの直接編集にはリスクが伴います。

## ライセンス
MIT
