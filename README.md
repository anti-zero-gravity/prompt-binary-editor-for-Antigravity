# Binary Prompt Editor

バイナリファイル（言語サーバーの実行ファイルなど）の中に埋め込まれたテキスト（システムプロンプト等）を検索・表示・編集するためのWebベースのHexエディタです。

![Python](https://img.shields.io/badge/Python-3.10+-blue) ![Flask](https://img.shields.io/badge/Flask-3.0+-green)

## 主な機能

- **Hexダンプビューア** — 仮想スクロールにより巨大なファイルも高速表示。
- **密度マップ** — 辞書単語の出現頻度を視覚化し、プロンプトの埋没箇所を特定。
- **スマート検索** — ASCII文字列の検索に加え、`%s` や `%d` などの**書式指定子（Verb）を含む文字列の曖昧マッチング**に対応。プロンプト内の変数部分を自動的に無視して位置を特定できます。
- **行マッピング** — 外部のプロンプトシート（Markdown等）の行テキストから、バイナリ内の対応するフラグメントを自動検出。
- **インライン編集** — 検索窓からの直接書き換え、Deleteキーによるスペース埋め。Undo/Redo完備。
- **セーフ保存** — 保存時に自動で `.bak` バックアップを作成。

## バイナリ書き換えの重要な手順

Antigravity等の実行中のアプリケーションが使用しているファイルを直接編集する場合、以下のいずれかの手順を踏む必要があります（**B手順を推奨**します）。

#### A. 直接編集する場合
1. Antigravity等、対象のバイナリを使用しているアプリケーションを**完全に終了**させます。
2. 本ツールで編集し、`Save` を実行します。
3. 保存完了後、アプリケーションを再起動します。

#### B. ワークスペースにコピーして編集する場合（推奨）
1. 対象のバイナリ（例: `Antigravity\resources\app\extensions\antigravity\bin\language_server_windows_x64.exe`）を本ツールのワークスペース内にコピーします。
2. 本ツールで「コピーしたファイル」を読み込み、編集・保存します。
3. 編集済みのファイルを元のディレクトリへ**上書きコピーして戻します**。

---

## クイックスタート

### 1. 依存ライブラリのインストール
```bash
pip install -r requirements.txt
```

### 2. ツールの起動とバイナリの読み込み
1. Windowsの場合、`start_editor.bat` をダブルクリックするだけでブラウザが起動します。
2. 初回起動時はエクスプローラが開き、編集対象のバイナリファイルのパスを求められます。
   - **直接開く場合**: `language_server_windows_x64.exe` を直接選択します（※書き込み時はAntigravityの終了が必要です）。
   - **コピーして開く場合（推奨）**: ファイル選択ダイアログ内で対象バイナリを右ドラッグし、「ここにコピー」等で `language_server_windows_x64 - コピー.exe` を作成してから、そのコピーを選択します。これならAntigravity起動中も安全にSave可能になります。
3. 選択したファイルパスは `path.ini` に自動保存され、次回以降に引き継がれます。

### 3. 編集作業のユースケース

#### ① 同梱のシステムプロンプト（`system_prompts.md`）の活用
初期プロンプトは、起動中のAntigravity（Claude Opus等）に出力させたものを同梱しています。
- **更新のタイミング**: Antigravityのアップデート時に再出力させるのが理想ですが、プロンプトの変更がない場合もあるため（例: 2026年1月アプデ時）、変更に気づいたタイミングでの更新で問題ありません。

#### ② 不要なプロンプトの削除による軽量化（コンテキスト節約）
ユーザーの用途に合わない不要なプロンプトをエージェントと相談して特定し、`0x20`（スペース）で埋めることでコンテキスト・トークンを節約できます。
1. **参考テキストの用意**: [HackMDの参考リスト](https://hackmd.io/KHTN7kjrS6KrFyCbX1weZA) 等を開き、画面内のテキストを全選択してコピーします。
2. **読み込み**: ツール右下の `clip` ボタンを押すと、ワークスペースに `import_日時.md` が生成され、下段にクリップボードの内容が表示されます。
3. **削除（無効化）の実行**: 表示された一覧から不要なプロンプト行を選択し、`DEL` キーを押すと、バイナリ内の該当プロンプトが空白で埋められます。ユーザー自身の判断で必要な箇所・量を埋めてください。
4. **動作確認**: 削除後もエージェントが正常に機能するかテストします。以前と変わらず動作すれば、コンテキスト節約の成功です。
   > **💡 補足**: 元の同梱プロンプト状態に戻したい場合は、生成された `import_日時.md` を削除するか、`path.ini` 内のシートパス指定を書き換えてください。

#### ③ プロンプト書き換えによるエージェントの挙動改善
既存のシステムプロンプトを同じバイト長の別の文章に書き換えることで、エージェントの振る舞いやツールの使い方を改善できます。
1. **対象プロンプトの特定**: エージェントに対し「現在の行動の根拠となったシステムプロンプトは何か？」と質問し、対象のプロンプト文を特定させます（※`<user_rules>` などのユーザー定義プロンプトは除く）。
2. **バイナリの検索と選択**: 特定した文をツールの検索窓に入れるか、ブラウザ内検索（`Ctrl+F`）を使って `system_prompts.md` 内から探し出し、対象行をクリックしてバイナリを選択状態にします。
3. **代替案の作成**: エージェント自身に改善案を考えさせます。このとき **「元のプロンプトと全く同じバイト長になるように考えろ」** と必ず指示してください。
4. **変更の書き込み**:
   - エージェントが考えた改善プロンプトを検索窓に入力します（**※元の文とバイト長が一致する場合のみ、書き込みアイコンが有効になります**）。
   - **直接exeを編集している場合**: Antigravity本体を終了させてから書き込みボタンを押してください。
   - **別ファイル（コピー）に保存している場合**: 書き込み後、ファイル名を `language_server_windows_x64.exe` 等にリネームし、元のパスへ上書きしてください。

#### ④ 動作不良時のバックアップからの復元
エージェントが期待した動作をしない、あるいは起動しなくなった場合は、自動生成されたバックアップ（`.bak`）ファイルから状態を復元（書き戻し）します。
1. 現在の `language_server_windows_x64.exe` を削除します。
2. 同じフォルダにある `language_server_windows_x64.bak` の拡張子を `.exe` に変更して元の名前に戻します。
   > **💡 補足**: 最初の `.bak` への上書きは行われず、以降は `.bak-2`、`.bak-3` のように連番で増えていく仕様です。
## キーボードショートカット

| キー | 動作 |
|---|---|
| `Ctrl + Z` | Undo（元に戻す） |
| `Ctrl + Shift + Z` / `Ctrl + Y` | Redo（やり直し） |
| `Delete` | 選択範囲を `0x20` (スペース) で埋める |
| `Ctrl + Enter` | 検索実行 / 次の候補 |
| `Ctrl + Shift + Enter` | 前の候補 (循環) |

## 免責事項
このツールは自己責任で使用してください。バイナリの直接編集にはリスクが伴います。

## ライセンス
MIT
